version: '3.8' 

services:
  # NestJS 应用服务
  nixizhiyuan-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nixizhiyuan-server
    restart: always
    ports:
      - '3002:3002'
    environment:
      - NODE_ENV=production
      - APP_PORT=3002
      # 使用已存在的 PostgreSQL 容器名称（与服务名 db 对应）
      - DB_HOST=rbridge-db
      - DB_PORT=5432
      # NestJS 应用使用的环境变量名称（从主应用的环境变量读取）
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_DATABASE=${POSTGRES_DB}
      # 使用已存在的 Redis 容器名称（与服务名 redis 对应）
      - REDIS_HOST=rbridge-redis
      - REDIS_PORT=6379
      # Redis 密码（从主应用的环境变量读取）
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # JWT 密钥（从主应用的环境变量读取）
      - JWT_SECRET=${JWT_SECRET}
    networks:
      # 连接到已存在的外部网络（主应用的 app-network）
      - rbridge_app-network
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

networks:
  # 使用已存在的外部网络（主应用的 app-network）
  rbridge_app-network:
    external: true

