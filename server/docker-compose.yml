version: '3.8' 

services:
  # NestJS 应用服务
  nixizhiyuan-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nixizhiyuan-server
    restart: always
    # 不暴露端口，仅通过 nginx 访问
    # ports:
    #   - '3002:3002'
    environment:
      - NODE_ENV=production
      - APP_PORT=3002
      # 使用已存在的 PostgreSQL 容器名称（与服务名 db 对应）
      - DB_HOST=rbridge-db
      - DB_PORT=5432
      # NestJS 应用使用的环境变量名称（从主应用的环境变量读取）
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_DATABASE=${POSTGRES_DB}
      # 使用已存在的 Redis 容器名称（与服务名 redis 对应）
      - REDIS_HOST=rbridge-redis
      - REDIS_PORT=6379
      # Redis 密码（从主应用的环境变量读取）
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      # JWT 密钥（从主应用的环境变量读取）
      - JWT_SECRET=${JWT_SECRET}
      # 微信小程序配置（从主应用的环境变量读取）
      - WECHAT_APP_ID=${WECHAT_APP_ID}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET}
      - CURRENT_YEAR=2025
      - SECRET_KEY=${SECRET_KEY}
      - OFFSET=${OFFSET}
    networks:
      # 连接到已存在的外部网络（主应用的 app-network）
      - rbridge_app-network
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

  # Nginx 反向代理服务
  nixizhiyuan-nginx:
    image: nginx:alpine
    container_name: nixizhiyuan-nginx
    restart: always
    ports:
      # 80 端口已被其他应用使用，仅使用 HTTPS
      # - '80:80'
      - '443:443'
    volumes:
      # Nginx 配置文件
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # HTTPS 证书文件
      - ./https-key:/etc/nginx/ssl:ro
      # Nginx 日志
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - nixizhiyuan-server
    networks:
      - rbridge_app-network

networks:
  # 使用已存在的外部网络（主应用的 app-network）
  rbridge_app-network:
    external: true

